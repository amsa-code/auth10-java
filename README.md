This library speaks the WS-Federation protocol and SAML 1.1 and 2.0 tokens. It interops fine with Microsoft-related products like ADFS, Windows Azure Active Directory and Windows Identity Foundation.

The code is a simplified version with some improvements of the library released by Microsoft <https://github.com/WindowsAzure/azure-sdk-for-java-samples>. 

## Usage

Clone it

	git clone https://github.com/amsa-code/auth10-java.git

Or download it as zip from <https://github.com/amsa-code/auth10-java/zipball/master>

Import the Maven that was just downloaded in your project (File -> Import -> Existing Maven Projects)

Add a reference to `com.auth10.federation` library from your project. Edit your project Maven file `pom.xml` and add this:

```xml
<dependencies>
	...
	<dependency>
		<groupId>com.auth10.federation</groupId>
		<artifactId>auth10-federation</artifactId>
		<version>0.9-SNAPSHOT</version>
	</dependency>
	...
</dependencies>
```

Add a federation.properties file under `resources` folder:

```
federation.trustedissuers.issuer=https://your_identity_provider/
federation.trustedissuers.thumbprint=CF50166CE4B....signing cert thumbprint...4DA668F96BF
federation.trustedissuers.friendlyname=My Identity Provider
federation.audienceuris=http://localhost:8080/sample-federation/
federation.realm=http://localhost:8080/sample-federation/
federation.enableManualRedirect=false
```

## Decrypting Assertions
In order to decrypt assertions you will need to place the matching private key in pk8 format to your /src/main/resources/rsa_private_key.pk8

If you generated your public/private key as a Java keystore (*.jks) then you can do the following to extract the private key.

First identify the alias name of the private key
```
keytool -list -v -keystore your-keystore-file.jks | grep "PrivateKeyEntry"
examplealias, 22/01/2010, PrivateKeyEntry, 
```

Extract the key into a PKCS12 container.
```
keytool -v -importkeystore -srckeystore you-keystore-file.jks -srcalias examplealias -destkeystore myp12file.p12 -deststoretype PCS12
```

Convert it to a PEM and then to a PKCS8 key.
```
openssl pkcs12 -in myp12file.p12 -nocerts -out key.pem
openssl pkcs8 -topk8 -nocrypt -inform PEM -in key.pem -outform DER -out rsa_private_key.pk8
```

You should have a resultant rsa_private_key.pk8 file that you can copy into your project's /src/main/resources/rsa_private_key.pk8

If the public/private key is *.pfx key generated by Microsoft Certificate Authority just do the following:
```
openssl pkcs12 -in mscertauth.pfx -nocerts -out key.pem
openssl pkcs8 -topk8 -nocrypt -inform PEM -in key.pem -outform DER -out rsa_private_key.pk8
```
You will also need to ensure you have installed the appropriate Java Cryptographic Extensions (JCE) to your JRE.

JCE for Java 7 can be found here : http://www.oracle.com/technetwork/java/javase/downloads/jce-7-download-432124.html
Follow the readme found in the JCE zip.

## Federation Filter Configuration

Add the `WSFederationFilter` to the `web.xml` file:

```xml
<filter>
  <filter-name>FederationFilter</filter-name>
  <filter-class>com.auth10.federation.WSFederationFilter</filter-class>
  <init-param>
    <param-name>login-page-url</param-name>
    <!-- this is used only if manual redirect is enabled. Otherwise the user will be automatically redirected to the identity provider when browsing the website -->
    <param-value>login.jsp</param-value>
  </init-param>
  <init-param>
    <param-name>exclude-urls-regex</param-name>
    <!-- e.g.: public folder won't be affected by the filter. To add more concat with pipe (|) -->
    <param-value>/public/*</param-value>
  </init-param>
</filter>
<filter-mapping>
  <filter-name>FederationFilter</filter-name>
  <url-pattern>/*</url-pattern>
</filter-mapping>
```

## Consuming user attributes

```java
// gets the user name
String name = request.getRemoteUser();

// gets the user claims
List<Claim> claims = ((FederatedPrincipal)request.getUserPrincipal()).getClaims()
```
